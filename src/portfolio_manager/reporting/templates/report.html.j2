<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Report — {{ report_date.strftime('%b %d, %Y') }}</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0; padding: 20px;
    background: #f5f5f5;
    color: #333;
  }
  .container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  .header {
    background: #1a1a2e;
    color: #fff;
    padding: 24px 32px;
  }
  .header h1 { margin: 0 0 8px; font-size: 22px; font-weight: 600; }
  .header .subtitle { font-size: 14px; opacity: 0.8; }
  .summary {
    display: flex;
    gap: 24px;
    padding: 20px 32px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    flex-wrap: wrap;
  }
  .summary-item { flex: 1; min-width: 140px; }
  .summary-label { font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-value { font-size: 20px; font-weight: 600; margin-top: 4px; }
  .positive { color: #28a745; }
  .negative { color: #dc3545; }
  section { padding: 20px 32px; border-bottom: 1px solid #e9ecef; }
  section:last-child { border-bottom: none; }
  h2 { font-size: 16px; color: #1a1a2e; margin: 0 0 16px; text-transform: uppercase; letter-spacing: 0.5px; }
  h2 .method { font-size: 12px; color: #6c757d; font-weight: normal; text-transform: none; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th {
    text-align: left;
    padding: 8px 12px;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  th.right, td.right { text-align: right; }
  td {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  tr:hover td { background: #f8f9fa; }
  .signal-breach_upper, .signal-breach_lower { color: #dc3545; font-weight: 600; }
  .signal-near_upper, .signal-near_lower { color: #fd7e14; font-weight: 500; }
  .signal-in_range { color: #28a745; }
  .footer {
    padding: 16px 32px;
    font-size: 12px;
    color: #6c757d;
    text-align: center;
    background: #f8f9fa;
  }
  .note { font-size: 12px; color: #6c757d; margin-top: 8px; }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <h1>Portfolio Report — {{ report_date.strftime('%b %d, %Y') }}</h1>
    <div class="subtitle">Daily Analytics & Performance Summary</div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="summary-item">
      <div class="summary-label">Total NAV</div>
      <div class="summary-value">{{ fmt_currency(total_nav) }}</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Daily P&L</div>
      <div class="summary-value {{ pnl_class(daily_pnl) }}">
        {{ fmt_currency(daily_pnl) }}
        ({{ fmt_pct(daily_pnl_pct / 100) if daily_pnl_pct is not none else 'N/A' }})
      </div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Cash</div>
      <div class="summary-value">{{ fmt_currency(total_cash) }} ({{ "%.1f"|format(cash_pct) }}%)</div>
    </div>
  </div>

  <!-- Portfolio Performance (TWR) -->
  <section>
    <h2>Portfolio Performance <span class="method">(Time-Weighted Return)</span></h2>
    <table>
      <thead>
        <tr>
          <th>Period</th>
          <th class="right">Return</th>
          <th class="right">P&amp;L</th>
        </tr>
      </thead>
      <tbody>
        {% for label, val, pnl in perf_periods %}
        <tr>
          <td>{{ label }}</td>
          <td class="right {{ pnl_class(val) }}">{{ fmt_pct(val) }}</td>
          <td class="right {{ pnl_class(pnl) }}">{{ fmt_currency(pnl) if pnl is not none else '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Holdings & Per-Stock Performance -->
  <section>
    <h2>Holdings & Per-Stock Performance <span class="method">(Price Return)</span></h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th class="right">Qty</th>
          <th class="right">Price</th>
          <th class="right">P&L</th>
          <th class="right">Weight</th>
          <th class="right">WoW</th>
          <th class="right">MTD</th>
          <th class="right">QTD</th>
          <th class="right">YTD</th>
          <th class="right">Prev Yr</th>
          <th class="right">Inception</th>
        </tr>
      </thead>
      <tbody>
        {% for p in positions %}
        {% set sp = stock_perf_map.get(p.symbol) %}
        <tr>
          <td><strong>{{ p.symbol.split('.')[0] }}</strong></td>
          <td class="right">{{ p.quantity }}</td>
          <td class="right">{{ fmt_currency(p.last_price) }}</td>
          <td class="right {{ pnl_class(p.unrealized_pnl) }}">{{ fmt_currency(p.unrealized_pnl) }}</td>
          <td class="right">{{ "%.1f"|format(p.weight) }}%</td>
          {% if sp %}
          <td class="right {{ pnl_class(sp.wow) }}">{{ fmt_pct(sp.wow) }}</td>
          <td class="right {{ pnl_class(sp.mtd) }}">{{ fmt_pct(sp.mtd) }}</td>
          <td class="right {{ pnl_class(sp.qtd) }}">{{ fmt_pct(sp.qtd) }}</td>
          <td class="right {{ pnl_class(sp.ytd) }}">{{ fmt_pct(sp.ytd) }}</td>
          <td class="right {{ pnl_class(sp.prev_year) }}">{{ fmt_pct(sp.prev_year) }}</td>
          <td class="right {{ pnl_class(sp.total_return) }}">{{ fmt_pct(sp.total_return) }}</td>
          {% else %}
          <td class="right">N/A</td>
          <td class="right">N/A</td>
          <td class="right">N/A</td>
          <td class="right">N/A</td>
          <td class="right">N/A</td>
          <td class="right">N/A</td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Weight Rebalancing -->
  {% if suggestions %}
  <section>
    <h2>Weight Rebalancing</h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th class="right">Current</th>
          <th class="right">Target</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for s in suggestions %}
        <tr>
          <td><strong>{{ s.symbol.split('.')[0] }}</strong></td>
          <td class="right">{{ "%.1f"|format(s.current_weight * 100) }}%</td>
          <td class="right">{{ "%.1f"|format(s.target_weight * 100) if s.target_weight is not none else 'N/A' }}%</td>
          <td>{{ s.detail }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="note">Only positions exceeding drift threshold shown.</div>
  </section>
  {% endif %}

  <!-- ATR Volatility Bands -->
  {% if atr_bands %}
  <section>
    <h2>ATR Volatility Bands
      {% if atr_period and atr_multiplier %}
      <span class="method">({{ atr_period }}-day, {{ atr_multiplier }}x multiplier)</span>
      {% endif %}
    </h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th class="right">Price</th>
          <th class="right">Lower</th>
          <th class="right">Upper</th>
          <th>Signal</th>
        </tr>
      </thead>
      <tbody>
        {% for b in atr_bands %}
        <tr>
          <td><strong>{{ b.symbol.split('.')[0] }}</strong></td>
          <td class="right">{{ fmt_currency(b.current_price) }}</td>
          <td class="right">{{ fmt_currency(b.lower_band) }}</td>
          <td class="right">{{ fmt_currency(b.upper_band) }}</td>
          <td class="signal-{{ b.signal }}">{{ b.signal|replace('_', ' ')|title }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}

  <!-- Closed Positions -->
  {% if closed_positions %}
  <section>
    <h2>Closed Positions <span class="method">(Realized P&L)</span></h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th class="right">Qty</th>
          <th class="right">Avg Buy</th>
          <th class="right">Avg Sell</th>
          <th class="right">P&L</th>
          <th class="right">P&L %</th>
          <th class="right">Last Trade</th>
        </tr>
      </thead>
      <tbody>
        {% for cp in closed_positions %}
        <tr>
          <td><strong>{{ cp.symbol.split('.')[0] }}</strong></td>
          <td class="right">{{ cp.total_bought_qty }}</td>
          <td class="right">{{ fmt_currency(cp.avg_buy_price) }}</td>
          <td class="right">{{ fmt_currency(cp.avg_sell_price) }}</td>
          <td class="right {{ pnl_class(cp.realized_pnl) }}">{{ fmt_currency(cp.realized_pnl) }}</td>
          <td class="right {{ pnl_class(cp.realized_pnl) }}">{{ "%+.1f"|format(cp.realized_pnl_pct) }}%</td>
          <td class="right">{{ cp.last_trade_date.strftime('%b %d, %Y') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}

  <!-- Footer -->
  <div class="footer">
    Generated {{ generated_at }}
  </div>

</div>
</body>
</html>
